# Aether Production Deployment (Ubuntu VPS + Portainer + Docker Swarm + Traefik)

This guide assumes:

- Docker Swarm is initialized on your VPS.
- Portainer is managing the Swarm cluster.
- Traefik is already running as your edge proxy on an external overlay network (for example `traefik-public`).

## 1) Build and publish images

This repo has GitHub Actions workflows that build and push images on `main`:

- `.github/workflows/agent.yml`
- `.github/workflows/orchestrator.yml`
- `.github/workflows/dashboard.yml`

Required GitHub secrets:

- `DOCKERHUB_USERNAME`
- `DOCKERHUB_TOKEN`

After pushing to `main`, images will be available as:

- `<DOCKERHUB_USERNAME>/aether-agent:latest`
- `<DOCKERHUB_USERNAME>/aether-orchestrator:latest`
- `<DOCKERHUB_USERNAME>/aether-dashboard:latest`

Tip: for safer rollouts, pin to immutable tags (commit SHA tags generated by workflows) instead of `latest`.

## 2) Prepare Swarm networks and host paths

Create/verify these on VPS:

1. External Traefik network exists (example: `traefik-public`).
2. Internal app overlay network name used by stack is `aether_network`.
3. Optional shared model cache host directory exists:

```bash
sudo mkdir -p /opt/aether/models
sudo chown -R 1000:1000 /opt/aether/models || true
```

## 3) Configure environment variables in Portainer

Use `.env.swarm.example` as your base for Portainer stack env vars.

Required minimum values:

- `DOMAIN` (example: `app.example.com`)
- `DOCKERHUB_USERNAME`
- `POSTGRES_PASSWORD`
- `BETTER_AUTH_SECRET`
- `AGENT_SECRET`
- `AGENT_NETWORK=aether_network`

Single env model for DB:

- Set `DATABASE_URL` to use one DB URL across dashboard and orchestrator, or
- leave `DATABASE_URL` empty to use the internal `postgres` service fallback from compose.

Recommended production values:

- `BETTER_AUTH_URL=https://<DOMAIN>`
- `BETTER_AUTH_TRUSTED_ORIGINS=https://<DOMAIN>`
- `CORS_ORIGINS=https://<DOMAIN>`
- `AGENT_SHARED_MODELS_HOST_PATH=/opt/aether/models`

Optional provider keys:

- `OPENAI_API_KEY`, `DEEPGRAM_API_KEY`, `ELEVENLABS_API_KEY`, `SARVAM_API_KEY`
- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`
- `SPOTIFY_CLIENT_ID`, `SPOTIFY_CLIENT_SECRET`

## 4) OAuth callback URLs to register

If you use plugin OAuth, configure these exact callback URLs in provider consoles:

- `https://<DOMAIN>/api/plugins/gmail/oauth/callback`
- `https://<DOMAIN>/api/plugins/spotify/oauth/callback`

## 5) Deploy stack in Portainer

Use `docker-compose.prod.yml`.

The file is configured to:

- Route `Host(<DOMAIN>) && PathPrefix(/api/auth)` to dashboard.
- Route `Host(<DOMAIN>) && PathPrefix(/api)` (excluding `/api/auth`) to orchestrator.
- Route `Host(<DOMAIN>)` to dashboard.
- Keep `postgres` internal only.

## 6) Validate deployment

Smoke checks:

```bash
curl -i https://<DOMAIN>/
curl -i https://<DOMAIN>/api/health
```

Functional checks:

1. Dashboard loads and login works.
2. Session endpoints under `/api/auth/*` work.
3. WebSocket connects to `wss://<DOMAIN>/api/ws`.
4. First user interaction spawns per-user agent container.

## 7) Rollout and rollback strategy

Recommended:

1. Deploy with pinned image tags (SHA).
2. Update one component at a time (`orchestrator` -> `dashboard`).
3. Monitor logs and health endpoints.
4. If regressions occur, redeploy previous pinned tags.

## 8) Security and operations checklist

- Never commit real `.env` values to git.
- Rotate `BETTER_AUTH_SECRET`, `AGENT_SECRET`, and provider keys regularly.
- Restrict VPS firewall to 80/443 ingress; keep DB private.
- Back up Docker volume used by Postgres (`postgres_data`).
- Enable log collection and alerting in your host/Traefik stack.

## 9) File references

- Production stack: `docker-compose.prod.yml`
- Full env template: `.env.example`
- Swarm env starter: `.env.swarm.example`
